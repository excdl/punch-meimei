<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{
  font-family: "Arial","Noto Sans TC",sans-serif;
  background: #f2f5f8;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}

.card{
  background:#fff;
  width:95%;
  max-width:480px;
  border-radius:18px;
  padding:25px 20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
}

#userInfo{
  font-size:26px;
  font-weight:bold;
  text-align:center;
}

#dateTime{
  font-size:22px;
  color:#555;
}

#statusContainer{
  display:flex;
  flex-direction:column;
  gap:5px;
  font-size:18px;
  font-weight:bold;
  text-align:center;
  margin-bottom:10px;
}

#btnClock{
  width:150px;
  height:150px;
  border-radius:50%;
  border:none;
  font-size:26px;
  font-weight:bold;
  color:white;
  background:#3498db;
  cursor:pointer;
  box-shadow:0 8px 15px rgba(0,0,0,0.2);
  transition:0.3s;
  position: relative;
  overflow: hidden;
}

#btnClock.off{ background:#2ecc71; }

#btnClock:active{
  transform: scale(0.95);
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
}

#btnClock .spinner{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  border:4px solid rgba(255,255,255,0.3);
  border-top:4px solid #fff;
  border-radius:50%;
  width:30px;
  height:30px;
  animation:spin 1s linear infinite;
  display:none;
}

@keyframes spin{
  0%{transform:translate(-50%,-50%) rotate(0deg);}
  100%{transform:translate(-50%,-50%) rotate(360deg);}
}

#todayRecords{
  width:100%;
  background:#fafafa;
  border-radius:12px;
  padding:15px;
  border:1px solid #ddd;
  font-size:18px;
  text-align:left;
  cursor:pointer;
}

#todayRecords span{
  display:block;
  margin-bottom:3px;
}
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">載入使用者資訊中...</div>
  <div id="dateTime">載入中…</div>

  <div id="statusContainer">
    <div id="nearestCompany">載入中</div>
    <div id="rangeStatus">判斷中</div>
  </div>

  <button id="btnClock">
    打卡
    <div class="spinner"></div>
  </button>

  <div id="todayRecords" onclick="updateTodayRecords()">今日打卡紀錄（點擊更新）</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzuKIcEz_ONu5_bTPC-J2DkcTJvi0Pe25TMl9SebheQyNhNYL5_fTtjYpY_nIS_ztou/exec";
let userId="",userName="";

async function initUser(){
  await liff.init({liffId:"2008504718-nmXP0WRV"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
}

function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

async function updateStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    try{
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      document.getElementById("nearestCompany").textContent = data.ipMatched ? data.nearestCompany.name : "不明連線";
      const distText = data.distance!==null ? ` (${data.distance.toFixed(0)} 公尺)` : "";
      document.getElementById("rangeStatus").textContent = `${data.rangeStatus}${!data.ipMatched ? distText : ""}`;
    }catch(err){
      document.getElementById("nearestCompany").textContent = "錯誤";
      document.getElementById("rangeStatus").textContent = "-";
    }
  });
}
setInterval(updateStatus,5000);
updateStatus();

async function updateTodayRecords(){
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  const container=document.getElementById("todayRecords");
  container.innerHTML="載入中...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    if(!data.length){container.innerHTML="今日打卡紀錄：無"; return;}
    container.innerHTML = "今日打卡紀錄：<br>";
    data.forEach(r=>{
      container.innerHTML += `<span>• ${r.status} ${r.time}（${r.company}）</span>`;
    });
  }catch{
    container.innerHTML="今日打卡紀錄：讀取失敗";
  }
}

// 打卡
document.getElementById("btnClock").onclick = async ()=>{
  const btn = document.getElementById("btnClock");
  const spinner = btn.querySelector(".spinner");
  btn.disabled = true;
  spinner.style.display="block";
  btn.textContent="打卡中…";
  spinner.style.display="block";

  const ip = await getIP();
  if(!navigator.geolocation){ Swal.fire("⚠ 無法取得位置"); return; }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body:JSON.stringify({userId,userName,ip,gps})
    });
    const data = await res.json();
    Swal.fire({icon:"success",title:data.message,html:`${data.date} ${data.time}`,timer:2000,showConfirmButton:false});

    btn.textContent="打卡";
    spinner.style.display="none";
    btn.disabled = false;
    updateTodayRecords();
  }, err=>{Swal.fire("⚠ 無法取得GPS位置"); btn.textContent="打卡"; spinner.style.display="none"; btn.disabled=false;});
}

window.onload = async ()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>



































































































































































































































































