<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f0f2f5; display:flex; justify-content:center; padding:20px; margin:0; }
.card { background:white; width:95%; max-width:480px; box-shadow:0 8px 25px rgba(0,0,0,0.12); border-radius:18px; padding:25px 20px; display:flex; flex-direction:column; align-items:center; gap:20px; }
#userInfo { font-size:22px; font-weight:bold; }
#companyInfo { font-size:18px; }
#statusInfo { font-size:18px; padding:6px 12px; border-radius:20px; display:inline-block; font-weight:bold; }
#clockBtn { width:120px; height:120px; border-radius:50%; border:none; font-size:22px; font-weight:bold; cursor:pointer; color:white; background:linear-gradient(145deg,#3498db,#2980b9); transition:0.3s; }
#clockBtn.clocked { background:linear-gradient(145deg,#2ecc71,#27ae60); }
#todayRecords { width:100%; background:#fafafa; border-radius:12px; padding:15px; border:1px solid #ddd; font-size:16px; cursor:pointer; }
#todayRecords b { font-weight:bold; }
</style>
</head>
<body>
<div class="card">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="companyInfo">公司資訊：載入中...</div>
    <button id="clockBtn">上班</button>
    <div id="todayRecords">今日打卡紀錄：點擊刷新</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbz2mQOcbbzncYpAN6lAuUA-Td35sJjadSvlaptfSnVKzF8ItqtlevJqZ6gdo9JNlB5u/exec"; // 替換成你的 GAS WebApp URL
let userId="", userName="", clockStatus="上班";

// 取得使用者資訊
async function initUser() {
    await liff.init({ liffId: "YOUR_LIFF_ID" }); // 替換成你的 LIFF ID
    if (!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} 您好`;
    updateTodayRecords();
}

// 取得 IP
async function getIP() {
    try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
    } catch {
        return "";
    }
}

// 取得 GPS
async function getGPS() {
    return new Promise((resolve,reject)=>{
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(
                pos => resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
                err => resolve(null),
                { enableHighAccuracy:true, timeout:5000 }
            );
        } else resolve(null);
    });
}

// 打卡
async function clockInOut(){
    const btn = document.getElementById("clockBtn");
    btn.disabled = true;
    const ip = await getIP();
    const gps = await getGPS();
    try {
        const res = await fetch(API_ENDPOINT, {
            method:"POST",
            body: JSON.stringify({
                userId, userName, status: clockStatus, ip, gps
            })
        });
        const data = await res.json();
        let companyText = data.nearestCompany || "不明連線";
        let distText = data.distance ? `${data.distance} 公尺` : "-";
        let color = (data.distance && data.distance>100) ? "red" : "#008000";
        document.getElementById("companyInfo").innerHTML = `公司名稱：<b>${companyText}</b> &nbsp; 距離：<b style="color:${color}">${distText}</b>`;
        Swal.fire({ icon:"success", title:data.message, html:`<b>${data.date} ${data.time}</b>`, timer:2000, showConfirmButton:false });
        // 切換狀態
        if(clockStatus==="上班"){ clockStatus="下班"; btn.classList.add("clocked"); btn.textContent="下班"; }
        else { clockStatus="上班"; btn.classList.remove("clocked"); btn.textContent="上班"; }
        updateTodayRecords();
    } catch(err){
        Swal.fire({ icon:"error", title:"打卡失敗", html: err.message });
    }
    btn.disabled = false;
}

// 更新今日打卡紀錄
async function updateTodayRecords(){
    const today = new Date().toISOString().slice(0,10);
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data = await res.json();
        if(!data.length){ document.getElementById("todayRecords").textContent="今日打卡紀錄：無"; return; }
        document.getElementById("todayRecords").innerHTML = "今日打卡紀錄：<br>" + data.map(r=>{
            return `${r.status} ${r.time} (${r.method}) ${r.nearestCompany||"-"} ${r.distance||"-"}公尺`;
        }).join("<br>");
    } catch {
        document.getElementById("todayRecords").textContent="今日打卡紀錄：讀取失敗";
    }
}

// 綁定事件
document.getElementById("clockBtn").addEventListener("click", clockInOut);
document.getElementById("todayRecords").addEventListener("click", updateTodayRecords);

// 初始化
document.addEventListener("DOMContentLoaded", initUser);
</script>
</body>
</html>






































































































































