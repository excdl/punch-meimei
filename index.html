<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { 
    font-family: Arial; 
    background:#f7f7f7;
    display:flex; 
    justify-content:center; 
    padding:25px; 
    margin:0;
}
.card {
    background:white;
    width:95%;
    max-width:480px;
    box-shadow:0 8px 25px rgba(0,0,0,0.12);
    border-radius:18px;
    padding:25px 20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
    text-align:center;
}
#userInfo { font-size:26px; font-weight:bold; }
#dateTime { font-size:22px; margin-bottom:10px; }

/* 公司資訊在按鈕上方 */
#companyInfo {
    display:flex;
    justify-content:center;
    gap:12px;
    font-size:18px;
    margin-bottom:8px;
    flex-wrap: nowrap;
}
#companyInfo .badge {
    display:inline-block;
    padding:6px 12px;
    font-weight:bold;
    border-radius:20px;
    white-space: nowrap;
}
.ok { background:#2ecc71; color:white; }
.err { background:#e74c3c; color:white; }

/* 圓形打卡按鈕 */
.circleBtn {
    width:140px; 
    height:140px; 
    border-radius:50%; 
    font-size:26px; 
    font-weight:bold; 
    border:none; 
    cursor:pointer; 
    transition:0.3s;
}
.circleBtn.on { background:#3498db; color:white; }
.circleBtn.off { background:#2ecc71; color:white; }

/* 今日打卡紀錄 */
#todayRecords {
    width:100%;
    background:#fafafa;
    border-radius:12px;
    padding:15px;
    border:1px solid #ddd;
    font-size:18px;
    cursor:pointer;
}

/* 響應式調整 */
@media(max-width:420px){
    #companyInfo { font-size:16px; gap:6px; }
    .circleBtn { width:120px; height:120px; font-size:22px; }
    #userInfo { font-size:22px; }
    #dateTime { font-size:20px; }
    #todayRecords { font-size:16px; }
}
</style>
</head>
<body>
<body>

<div class="card">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="dateTime">載入中…</div>

    <div class="status-container">
        <span id="nearestCompany">載入中</span>
        <span id="rangeStatus">判斷中</span>
    </div>

    <button id="btnClock" class="circleBtn on">上班</button>

    <div id="todayRecords" onclick="updateTodayRecords()">今日打卡紀錄：點擊可刷新</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwtunY5z3YswB8AB2HgOpa0o3vX1lfcKTYEIyFgFyO9skgpJ5M9AbQdtDrRXtv977Zl/exec";
let userId = "", userName = "", isClockIn = true;

function updateDateTime(){
    const now = new Date();
    document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

async function initLIFF(){
    await liff.init({liffId:"2008504718-nmXP0WRV"});
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} 您好`;
    await checkCompanyStatus();
    updateTodayRecords();
}

// 取得 IP
async function getIP() {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
}

// 檢查公司與距離
async function checkCompanyAndDistance(){
    let ip = await getIP();
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async pos=>{
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            fetch(`https://script.google.com/macros/s/你的WEB_APP_ID/exec?action=check&lat=${lat}&lng=${lng}&ip=${ip}`)
            .then(res=>res.json())
            .then(data=>{
                document.getElementById("nearestCompany").textContent = data.ipMatched ? data.nearestCompany.name : "不明連線";
                document.getElementById("rangeStatus").textContent = data.rangeStatus;
            }).catch(()=>{ 
                document.getElementById("nearestCompany").textContent="載入失敗";
                document.getElementById("rangeStatus").textContent="";
            });
        });
    }
}

// 打卡
async function punch(status){
    let ip = await getIP();
    let gps = null;
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            gps = {lat: pos.coords.latitude, lng: pos.coords.longitude};
            postPunch(status, ip, gps);
        });
    } else {
        postPunch(status, ip, gps);
    }
}

function postPunch(status, ip, gps){
    fetch("https://script.google.com/macros/s/你的WEB_APP_ID/exec",{
        method:"POST",
        body: JSON.stringify({userId, userName, status, ip, gps})
    })
    .then(res=>res.json())
    .then(data=>{
        Swal.fire('打卡成功', `${status} ${data.nearestCompany} ${data.rangeStatus}`, 'success');
        checkCompanyAndDistance();
        loadTodayRecords();
    }).catch(err=>{
        Swal.fire('打卡失敗', err.message, 'error');
    });
}

// 今日打卡紀錄
function loadTodayRecords(){
    const dateStr = new Date().toISOString().slice(0,10); // yyyy-mm-dd
    fetch(`https://script.google.com/macros/s/你的WEB_APP_ID/exec?action=getToday&userId=${userId}&date=${dateStr}`)
    .then(res=>res.json())
    .then(data=>{
        if(!data || !data.length){
            document.getElementById("todayRecords").textContent="今日打卡紀錄：無";
            return;
        }
        let html = "今日打卡紀錄：\n";
        data.forEach(r=>{
            html += `${r.status} ${r.time} ${r.method} ${r.ip} ${r.nearestCompany} ${r.rangeStatus}\n`;
        });
        document.getElementById("todayRecords").textContent = html;
    }).catch(()=>{
        document.getElementById("todayRecords").textContent="今日打卡紀錄：讀取失敗";
    });
}

// 綁定按鈕
document.getElementById("btnStart").addEventListener("click",()=>punch("上班"));
document.getElementById("btnEnd").addEventListener("click",()=>punch("下班"));
</script>
</body>
</html>










































































































































































































































































