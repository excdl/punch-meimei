<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:"Arial","Noto Sans TC",sans-serif;background:#f0f4f8;display:flex;justify-content:center;padding:20px;margin:0}
.card{background:#fff;width:95%;max-width:480px;border-radius:20px;padding:25px 20px;display:flex;flex-direction:column;align-items:center;gap:20px;box-shadow:0 15px 30px rgba(0,0,0,.15)}
#userInfo{font-size:26px;font-weight:bold;color:#2c3e50}
#dateTime{font-size:20px;color:#7f8c8d}
#statusInfo{font-size:18px;color:white;padding:8px 25px;border-radius:25px;min-width:180px;text-align:center}
.buttons-container{display:flex;gap:15px;width:100%}
.buttons-container button{flex:1;padding:15px 0;font-size:22px;font-weight:bold;border-radius:12px;border:none;color:white;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
#btnStart{background:linear-gradient(135deg,#3498db,#2980b9)}
#btnEnd{background:linear-gradient(135deg,#2ecc71,#27ae60)}
#todayRecords{width:100%;background:#fafafa;border-radius:14px;padding:15px;border:1px solid #ddd;font-size:17px}
#todayRecords span{display:block;margin-bottom:5px;padding-left:6px;border-left:3px solid #3498db}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä¸­...</div>
  <div id="statusInfo">æª¢æŸ¥ä¸­â€¦</div>
  <div id="dateTime"></div>

  <div class="buttons-container">
    <button id="btnStart" disabled>ä¸Šç­</button>
    <button id="btnEnd" disabled>ä¸‹ç­</button>
  </div>

  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„</div>
</div>

<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbzmiYZPRcsliCLaCARTIhBNYAB4oRjB4rKUczOBn8QjKt71lxbylQ1t-w24obpR4dNI/exec";
let userId="",userName="",dataReady=false;

const btnStart=document.getElementById("btnStart");
const btnEnd=document.getElementById("btnEnd");
const userInfo=document.getElementById("userInfo");
const statusInfo=document.getElementById("statusInfo");
const dateTime=document.getElementById("dateTime");
const todayRecords=document.getElementById("todayRecords");

/* ===== æ—¥æœŸå­—ä¸² yyyy/MM/dd ===== */
function getTodayString(){
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== æŒ‰éˆ•é–å®š ===== */
function setButtonsLock(lock){btnStart.disabled=lock;btnEnd.disabled=lock}

/* ===== æ™‚é–“é¡¯ç¤º ===== */
function updateDateTime(){dateTime.textContent=new Date().toLocaleString("zh-TW",{hour12:false})}
setInterval(updateDateTime,1000);
updateDateTime();

/* ===== IP ===== */
async function getIP(){
  const cache=sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const r=await fetch("https://api.ipify.org?format=json");
    const d=await r.json();
    sessionStorage.setItem("myIP",d.ip);
    return d.ip;
  }catch{return "";}
}

/* ===== GPS å¿«å– ===== */
let lastGPS=null,lastGPSAt=0;
function getCachedGPS(maxAge=15000){
  return new Promise((resolve,reject)=>{
    const now=Date.now();
    if(lastGPS && now-lastGPSAt<maxAge){resolve(lastGPS);return;}
    navigator.geolocation.getCurrentPosition(
      p=>{lastGPS={lat:p.coords.latitude,lng:p.coords.longitude};lastGPSAt=Date.now();resolve(lastGPS)},
      e=>reject(e),
      {enableHighAccuracy:false,timeout:5000}
    );
  });
}

/* ===== LIFF ===== */
async function initUser(){
  await liff.init({liffId:"2008786085-L1CtKqqv"});
  if(!liff.isLoggedIn()) await liff.login();
  const p=await liff.getProfile();
  userId=p.userId;
  userName=p.displayName;
  userInfo.textContent=`${userName} æ‚¨å¥½`;
}

/* ===== ç‹€æ…‹æ›´æ–° ===== */
async function updateStatus(){
  try{
    const ip=await getIP();
    const gps=await getCachedGPS();
    const r=await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const d=await r.json();
    statusInfo.style.background=d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"?"#2ecc71":"#e74c3c";
    statusInfo.textContent=d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"?"æœ‰æ•ˆæ‰“å¡å€":`ç„¡æ•ˆæ‰“å¡å€${d.distance?` (${d.distance} å…¬å°º)`:""}`;
  }catch{}
}

/* ===== ä»Šæ—¥ç´€éŒ„ ===== */
async function updateTodayRecords(){
  todayRecords.textContent="è¼‰å…¥ä¸­...";
  try{
    const r=await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${getTodayString()}`);
    const data=await r.json();
    if(!data.length){todayRecords.textContent="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";return;}
    todayRecords.innerHTML=["ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>",...data.map(x=>`<span>${x.status}ï¼š${x.time}ï¼ˆ${x.company}ï¼‰</span>`)].join("");
  }catch{todayRecords.textContent="è®€å–å¤±æ•—";}
}

/* ===== æ‰“å¡ ===== */
async function clockInOut(status){
  if(!dataReady){Swal.fire({icon:"info",title:"è³‡æ–™è®€å–ä¸­",timer:1500,showConfirmButton:false});return;}
  const btn=status==="ä¸Šç­"?btnStart:btnEnd;
  btn.disabled=true;
  const txt=btn.textContent;
  let sec=3;
  const t=setInterval(()=>{btn.textContent=`æ‰“å¡ä¸­ ${sec--}s`;},1000);

  try{
    const ip=await getIP();
    const gps=await getCachedGPS();
    const r=await fetch(API_ENDPOINT,{method:"POST",body:JSON.stringify({userId,userName,ip,gps,status})});
    const d=await r.json();
    Swal.fire({icon:d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"?"success":"warning",title:d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"?"ğŸ‰ æ‰“å¡æˆåŠŸ":"âš  æ‰“å¡ç„¡æ•ˆ",timer:2000,showConfirmButton:false});
    updateTodayRecords();updateStatus();
  }catch{Swal.fire({icon:"error",title:"æ‰“å¡å¤±æ•—",timer:2000,showConfirmButton:false});}
  finally{clearInterval(t);btn.textContent=txt;btn.disabled=false;}
}

btnStart.onclick=()=>clockInOut("ä¸Šç­");
btnEnd.onclick=()=>clockInOut("ä¸‹ç­");

window.onload=async()=>{
  setButtonsLock(true);
  await Promise.all([initUser(),updateTodayRecords(),updateStatus()]);
  dataReady=true;
  setButtonsLock(false);
  setInterval(updateStatus,15000);
};
</script>
</body>
</html>





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































