<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINE 智能打卡</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body{background:#f5f6fa;font-family:Arial;display:flex;justify-content:center}
.card{background:#fff;width:95%;max-width:420px;padding:25px;border-radius:20px;box-shadow:0 8px 20px rgba(0,0,0,.15);text-align:center}
.clockBtn{width:140px;height:140px;border-radius:50%;border:none;font-size:26px;font-weight:bold;color:#fff;background:#3498db}
.statusBox{display:flex;gap:10px;margin:10px 0}
.status{flex:1;padding:10px;border-radius:10px;font-weight:bold}
.ok{background:#2ecc71;color:#fff}
.fail{background:#e74c3c;color:#fff}
#today{margin-top:15px;text-align:left}
</style>
</head>
<body>

<div class="card">
  <h2 id="user"></h2>
  <div id="time"></div>

  <div class="statusBox">
    <div id="company" class="status">定位中</div>
    <div id="range" class="status">判斷中</div>
  </div>

  <button class="clockBtn" onclick="clock()">打卡</button>
  <div id="today">今日打卡紀錄：</div>
</div>

<script>
const API="你的 Web App URL";
let userId="",userName="";

liff.init({liffId:"你的 LIFF ID"}).then(async()=>{
  if(!liff.isLoggedIn()) liff.login();
  const p=await liff.getProfile();
  userId=p.userId; userName=p.displayName;
  document.getElementById("user").textContent=`${userName} 您好`;
  loadToday();
});

setInterval(()=>time.textContent=new Date().toLocaleString("zh-TW",{hour12:false}),1000);

async function clock(){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const ip=(await fetch("https://api.ipify.org?format=json").then(r=>r.json())).ip;

    const res=await fetch(API,{method:"POST",body:JSON.stringify({userId,userName,ip,gps})});
    const data=await res.json();
    Swal.fire(data.message,"","success");
    loadToday();
  });
}

function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

async function loadToday(){
  const res=await fetch(`${API}?action=getToday&userId=${userId}&date=${today()}`);
  const data=await res.json();
  today.innerHTML="今日打卡紀錄：<br>"+data.map(r=>`• ${r.status} ${r.time}（${r.company}）`).join("<br>");
}
</script>
</body>
</html>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyTQRdDmtXQHvLk1rib4k5toid8ko4oS4VbwF61seZvUJ-JOEKXtOvub_YjYJxD6Xua/exec";
let userId="",userName="",isClockIn=true;

async function initUser(){
  await liff.init({liffId:"2008504718-nmXP0WRV"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
}

function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

// 每 5 秒更新公司與範圍
async function updateStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    try{
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      document.getElementById("nearestCompany").textContent = data.ipMatched ? data.nearestCompany.name : "不明連線";
      document.getElementById("rangeStatus").textContent = data.rangeStatus;
    }catch(err){
      document.getElementById("nearestCompany").textContent = "錯誤";
      document.getElementById("rangeStatus").textContent = "-";
    }
  });
}
setInterval(updateStatus,5000);
updateStatus();

// 打卡
document.getElementById("btnClock").onclick = async ()=>{
  const ip = await getIP();
  if(!navigator.geolocation){ Swal.fire("⚠ 無法取得位置"); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const status = isClockIn?"上班":"下班";
    const res = await fetch(API_ENDPOINT,{method:"POST",body:JSON.stringify({userId,userName,status,ip,gps})});
    const data = await res.json();
    Swal.fire({icon:"success",title:data.message,html:`${data.date} ${data.time}`,timer:2000,showConfirmButton:false});
    isClockIn=!isClockIn;
    const btn=document.getElementById("btnClock");
    btn.textContent = isClockIn?"上班":"下班";
    btn.className = `btnClock ${isClockIn?"":"off"}`;
    updateTodayRecords();
  },err=>{Swal.fire("⚠ 無法取得GPS位置");});
}

// 今日打卡紀錄
async function updateTodayRecords(){
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    const container=document.getElementById("todayRecords");
    if(!data.length){container.innerHTML="今日打卡紀錄：無"; return;}
    container.innerHTML="今日打卡紀錄：<br>"+data.map(r=>`${r.status} ${r.time} ${r.method} ${r.ip} ${r.nearestCompany} ${r.rangeStatus}`).join("<br>");
  }catch{document.getElementById("todayRecords").innerHTML="今日打卡紀錄：讀取失敗";}
}

window.onload = async ()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>








































































































































































































































































