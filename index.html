<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { 
    font-family: Arial, sans-serif; 
    background:#f0f2f5;
    display:flex; 
    justify-content:center; 
    padding:25px; 
    margin:0;
}
.card {
    background:white;
    width:95%;
    max-width:480px;
    box-shadow:0 8px 25px rgba(0,0,0,0.12);
    border-radius:18px;
    padding:25px 20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
}
#userInfo { font-size:24px; font-weight:bold; }
#statusInfo { font-size:18px; padding:6px 18px; border-radius:30px; display:inline-block; font-weight:bold; }
#dateTime { font-size:20px; }
#clockButton {
    width:120px;
    height:120px;
    border-radius:50%;
    border:none;
    background: linear-gradient(145deg, #3498db, #2980b9);
    color:white;
    font-size:22px;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
}
#clockButton.clockedOut {
    background: linear-gradient(145deg, #2ecc71, #27ae60);
}
#todayRecords {
    width:100%;
    background:#fafafa;
    border-radius:12px;
    padding:15px;
    border:1px solid #ddd;
    font-size:18px;
    cursor:pointer;
}
#clockButton:hover {
    transform: scale(1.05);
}
</style>
</head>
<body>

<div class="card">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="statusInfo"></div>
    <div id="dateTime">載入中…</div>

    <button id="clockButton">上班</button>

    <div id="todayRecords" onclick="refreshTodayRecords()">
        今日打卡紀錄：點擊刷新
    </div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbw-2gfh4f7gfA0NVL_Jt4Y4tBYxhr4FfQ4sdoV9yIMjy7GRdIwz3n-zz8iBm4Wph-xs/exec";

// ===== 更新時間 =====
function updateDateTime() {
    const now = new Date();
    document.getElementById("dateTime").textContent =
        now.toLocaleString("zh-TW", { hour12: false });
}
setInterval(updateDateTime, 1000);
updateDateTime();

async function getIP(){
    const cache = sessionStorage.getItem("myIP");
    if(cache) return cache;
    try{
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        sessionStorage.setItem("myIP", data.ip);
        return data.ip;
    }catch{
        return "";
    }
}

let userId = "", userName = "";
let clockStatus = "上班"; // 預設上班

async function initUser(){
    await liff.init({ liffId:"你的LIFF ID" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} 您好`;
    document.getElementById("statusInfo").textContent = "GPS+IP 打卡模式";
    updateTodayRecords();
}

async function performClock(){
    const btn = document.getElementById("clockButton");
    btn.disabled = true;
    btn.textContent = clockStatus === "上班" ? "打卡中..." : "打卡中...";

    const ip = await getIP();
    let gps = null;
    try{
        gps = await new Promise((resolve, reject)=>{
            navigator.geolocation.getCurrentPosition(
                pos => resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
                err => resolve(null), // 失敗就傳 null
                { enableHighAccuracy:true, timeout:10000 }
            );
        });
    }catch(e){ gps=null; }

    // 發送後端
    const res = await fetch(API_ENDPOINT,{
        method:"POST",
        body: JSON.stringify({userId, userName, status:clockStatus, ip, gps}),
    });
    const data = await res.json();

    Swal.fire({
        icon: data.message.includes("成功") ? "success" : "error",
        title: data.message,
        html: data.date && data.time ? `時間：${data.date} ${data.time}` : "",
        showConfirmButton:false,
        timer:2000
    });

    // 切換上下班
    clockStatus = clockStatus==="上班" ? "下班" : "上班";
    btn.textContent = clockStatus;
    btn.classList.toggle("clockedOut");
    btn.disabled = false;

    updateTodayRecords();
}

// ===== 今日紀錄 =====
async function updateTodayRecords(){
    const today = new Date().toISOString().slice(0,10);
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data = await res.json();
        const container = document.getElementById("todayRecords");
        if(!data.length){
            container.innerHTML = "今日打卡紀錄：無";
            return;
        }
        container.innerHTML = "今日打卡紀錄：<br>" + data.map(r=>{
            const ipLabel = r.ip ? `(IP: ${r.ip})` : "";
            const gpsLabel = r.lat && r.lng ? `(GPS: ${r.lat.toFixed(5)},${r.lng.toFixed(5)})` : "";
            const companyLabel = r.nearestCompany ? `(${r.nearestCompany} ${r.distance}m)` : "";
            return `${r.status} ${r.time} ${ipLabel} ${gpsLabel} ${companyLabel}`;
        }).join("<br>");
    }catch(e){
        console.error(e);
    }
}

function refreshTodayRecords(){ updateTodayRecords(); }

document.getElementById("clockButton").onclick = performClock;

window.onload = initUser;
</script>
</body>
</html>






































































































































